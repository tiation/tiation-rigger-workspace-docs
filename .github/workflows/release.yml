# ğŸš€ Tiation Rigger Workspace Documentation - Release Pipeline
# Enterprise-grade automated release workflow
# Includes: Semantic versioning, changelog generation, and artifact publishing

name: ğŸ·ï¸ Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Is this a prerelease?'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  # ğŸ—ï¸ Build and Test
  build:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ” Run quality checks
        run: |
          echo "ğŸ” Running quality checks..."
          npm run lint
          npm run format -- --check

      - name: ğŸ—ï¸ Build documentation
        run: |
          echo "ğŸ—ï¸ Building documentation..."
          # Add build commands here
          echo "Build completed successfully!"

      - name: ğŸ“¦ Package artifacts
        run: |
          echo "ğŸ“¦ Creating release package..."
          tar -czf tiation-rigger-workspace-docs-${{ github.ref_name }}.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.github' \
            .

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: tiation-rigger-workspace-docs-*.tar.gz

  # ğŸ“‹ Generate Release Notes
  changelog:
    name: ğŸ“‹ Generate Changelog
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Generate changelog
        id: changelog
        run: |
          echo "ğŸ“‹ Generating changelog..."
          
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "changelog=Initial release of Tiation Rigger Workspace Documentation" >> $GITHUB_OUTPUT
          else
            # Generate changelog between tags
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

  # ğŸ·ï¸ Create Release
  release:
    name: ğŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    needs: [build, changelog]
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¤ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-package

      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Tiation Rigger Workspace Docs ${{ github.ref_name }}"
          body: |
            ## ğŸš€ Tiation Rigger Workspace Documentation Release ${{ github.ref_name }}
            
            ### ğŸ¯ What's New
            ${{ needs.changelog.outputs.release_notes }}
            
            ### ğŸ› ï¸ Enterprise Features
            - âœ… Professional documentation architecture
            - ğŸ¨ Dark neon theme with cyan gradient flares
            - ğŸ“Š Comprehensive deployment guides
            - ğŸ”— GitHub-centered linking (no tiation.com references)
            
            ### ğŸ“¦ Downloads
            - **Documentation Package**: `tiation-rigger-workspace-docs-${{ github.ref_name }}.tar.gz`
            - **Live Site**: [GitHub Pages](https://tiation.github.io/tiation-rigger-workspace-docs)
            
            ### ğŸ”§ Installation
            ```bash
            wget https://github.com/tiation/tiation-rigger-workspace-docs/releases/download/${{ github.ref_name }}/tiation-rigger-workspace-docs-${{ github.ref_name }}.tar.gz
            tar -xzf tiation-rigger-workspace-docs-${{ github.ref_name }}.tar.gz
            ```
            
            ---
            
            ğŸ† **Dark neon theme with cyan gradient flares active!**
            
            Built with enterprise-grade standards and streamlined workflows.
          files: |
            tiation-rigger-workspace-docs-*.tar.gz
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          draft: false

  # ğŸ”” Notify Success
  notify:
    name: ğŸ”” Notify
    runs-on: ubuntu-latest
    needs: [release]
    if: always()
    steps:
      - name: ğŸ‰ Release success notification
        if: needs.release.result == 'success'
        run: |
          echo "ğŸ‰ Release ${{ github.ref_name }} created successfully!"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo "ğŸŒ Live Site: https://tiation.github.io/tiation-rigger-workspace-docs"
          echo "ğŸ† Dark neon theme with cyan gradient flares deployed!"

      - name: âŒ Release failure notification
        if: needs.release.result != 'success'
        run: |
          echo "âŒ Release ${{ github.ref_name }} failed!"
          echo "ğŸ” Check the workflow logs for details."
          exit 1
